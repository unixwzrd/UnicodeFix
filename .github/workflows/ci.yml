name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"
        # Ensure scripts are in PATH
        export PATH="$HOME/.local/bin:$PATH"

    - name: Verify cleanup-text is available
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        which cleanup-text && cleanup-text --help || python -m unicodefix.cli --help

    - name: Run Python unit tests
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        pytest tests/ -v --cov=src/unicodefix --cov-report=term-missing || pytest tests/ -v

    - name: Run integration test suite
      run: |
        chmod +x tests/test_all.sh
        # Ensure cleanup-text is in PATH
        export PATH="$HOME/.local/bin:$PATH"
        mkdir -p /tmp/bin
        cat > /tmp/bin/cleanup-text <<'EOF'
        #!/usr/bin/env bash
        python -m unicodefix.cli "$@"
        EOF
        chmod +x /tmp/bin/cleanup-text
        export PATH="/tmp/bin:$PATH"
        bash tests/test_all.sh

    - name: Validate newline preservation
      run: |
        python3 << 'EOF'
        import sys
        sys.path.insert(0, 'src')
        from unicodefix.transforms import clean_text
        
        # Test critical newline preservation
        test_cases = [
            ("Line 1\nLine 2\nLine 3\n", "Multi-line with trailing newline"),
            ("Line 1\nLine 2\nLine 3", "Multi-line without trailing newline"),
            ("Line 1\n\nLine 2\n", "Multi-line with empty line"),
            ('"Line 1"\n"Line 2"\n', "Multi-line with Unicode quotes"),
        ]
        
        all_passed = True
        for text, description in test_cases:
            result = clean_text(text)
            orig_newlines = text.count('\n')
            result_newlines = result.count('\n')
            if result_newlines < orig_newlines:
                print(f"FAIL: {description}")
                print(f"  Original newlines: {orig_newlines}, Result newlines: {result_newlines}")
                all_passed = False
            else:
                print(f"PASS: {description}")
        
        if not all_passed:
            sys.exit(1)
        print("\n✓ All newline preservation tests passed")
        EOF

    - name: Check test output for newline issues
      run: |
        # Verify that cleaned files maintain line structure
        if [ -d test_output/default ]; then
          for file in test_output/default/*.txt test_output/default/*.py test_output/default/*.c; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -lt 1 ]; then
                echo "ERROR: $file has no lines (newlines may have been stripped)"
                exit 1
              fi
            fi
          done
          echo "✓ All cleaned files maintain line structure"
        fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check code formatting with black
      run: |
        black --check src/ tests/

    - name: Lint with ruff
      run: |
        ruff check src/ tests/ || echo "Note: Some linting issues found. Run 'ruff check --fix src/ tests/' to auto-fix."

  shellcheck:
    name: Shell Script Linting
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: 'tests/'
